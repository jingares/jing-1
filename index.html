<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: #ffffff; border: 2px solid #e2e8f0; box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.05); border-radius: 1.5rem; }
        
        /* åƒç´ æ˜Ÿæ˜Ÿå‹•ç•« */
        @keyframes starBlink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.2); }
        }
        .pixel-star { display: inline-block; animation: starBlink 2s infinite; color: #fbbf24; }

        /* Payer é¸å–å™¨ç¾åŒ– */
        .payer-option { display: none; }
        .payer-label { 
            display: flex; align-items: center; justify-content: center; 
            padding: 12px 8px; border-radius: 12px; font-weight: 700; font-size: 14px; 
            background: #f1f5f9; cursor: pointer; border: 2px solid transparent; transition: 0.2s; 
        }
        .payer-option:checked + .payer-label { background: #1e293b; color: #fff; transform: translateY(-2px); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* æ¨™ç±¤é…è‰²å„ªåŒ– */
        .tag-pig { color: #c2410c; background: #fff7ed; border-radius: 6px; padding: 2px 8px; font-weight: 700; }
        .tag-clean { color: #0369a1; background: #f0f9ff; border-radius: 6px; padding: 2px 8px; font-weight: 700; }
        .tag-settled { color: #64748b; background: #f1f5f9; text-decoration: line-through; opacity: 0.5; }
    </style>

    <script>
        let submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart = null;

        // è¨»å†Šå¤–æ›
        Chart.register(ChartDataLabels);

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('âœ¨ ç´€éŒ„å­˜æª”æˆåŠŸï¼ âœ§*ï½¡Ù©(ËŠá—œË‹*)Ùˆâœ§*ï½¡ âœ¨');
                location.reload();
            }
        };

        async function fetchData() {
            try {
                const res = await fetch(`${csvUrl}&t=${Date.now()}`);
                const text = await res.text();
                const rows = text.split('\n').filter(r => r.trim() !== "").slice(1);
                
                let income = 15000, totalExpense = 0, walletPaidDirectly = 0, settledReimbursements = 0;
                let pigOwed = 0, cleanOwed = 0;
                let categoryData = {};
                let recentHtml = "";

                rows.forEach(row => {
                    const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const amt = parseFloat(c[1]) || 0;
                    const cat = c[2], payer = c[3], isSettled = (c[5] === "æ˜¯");

                    if (cat === "æ”¶å…¥" || amt < 0) {
                        income += Math.abs(amt);
                    } else {
                        totalExpense += amt;
                        categoryData[cat] = (categoryData[cat] || 0) + amt;
                        if (payer === "å…±åŒéŒ¢åŒ…") {
                            walletPaidDirectly += amt;
                        } else {
                            if (isSettled) settledReimbursements += amt;
                            else {
                                if (payer === "æ¿Ÿè±¬") pigOwed += amt;
                                if (payer === "æ¿Ÿæ·¨") cleanOwed += amt;
                            }
                        }
                    }
                });

                const currentBalance = income - walletPaidDirectly - settledReimbursements;
                document.getElementById('wallet-balance').innerText = currentBalance.toLocaleString();
                document.getElementById('pig-owed').innerText = '$' + pigOwed.toLocaleString();
                document.getElementById('clean-owed').innerText = '$' + cleanOwed.toLocaleString();

                [...rows].reverse().slice(0, 5).forEach(row => {
                    const c = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const isSettled = (c[5] === "æ˜¯");
                    if (c[2] === "æ”¶å…¥") return;

                    recentHtml += `
                        <div class="flex justify-between items-center py-4 border-b border-slate-100 last:border-0 ${isSettled ? 'opacity-40' : ''}">
                            <div>
                                <div class="font-bold text-slate-800 text-sm">${c[2]} ${isSettled ? 'âœ…' : ''}</div>
                                <div class="text-[11px] text-slate-400 font-bold">${c[4]}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-slate-900 text-lg">$${parseFloat(c[1]).toLocaleString()}</div>
                                <span class="text-[10px] ${isSettled ? 'tag-settled' : (c[3]==='æ¿Ÿè±¬'?'tag-pig':'tag-clean')}">${c[3]}</span>
                            </div>
                        </div>`;
                });
                document.getElementById('recent-list').innerHTML = recentHtml || "å°šæœªæœ‰æ•¸æ“š";
                renderChart(categoryData, totalExpense);
            } catch (err) { console.error("Data Load Error:", err); }
        }

        function renderChart(catData, grandTotal) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChart) expenseChart.destroy();

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catData).map(k => `${k} (${((catData[k]/grandTotal)*100).toFixed(0)}%)`),
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#818cf8', '#f87171', '#fbbf24', '#34d399', '#f472b6', '#94a3b8'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '72%',
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 12, weight: '700' } } },
                        datalabels: {
                            color: '#fff',
                            backgroundColor: 'rgba(0,0,0,0.2)',
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 10 },
                            formatter: (val) => val > (grandTotal * 0.05) ? `$${val.toLocaleString()}` : '', // ä½”æ¯”å¤ªå°ä¸é¡¯ç¤ºé¿å…æ“ å£“
                            display: 'auto'
                        }
                    }
                },
                plugins: [{
                    beforeDraw: (chart) => {
                        const { width, height, ctx } = chart;
                        ctx.restore();
                        ctx.font = "700 13px Noto Sans TC";
                        ctx.fillStyle = "#94a3b8";
                        ctx.textAlign = "center";
                        ctx.fillText("ç¸½æ”¯å‡º", width / 2, height / 2 - 12);
                        ctx.font = "900 22px Noto Sans TC";
                        ctx.fillStyle = "#1e293b";
                        ctx.fillText(`$${grandTotal.toLocaleString()}`, width / 2, height / 2 + 15);
                        ctx.save();
                    }
                }]
            });
        }

        function openTab(t) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('text-slate-900', 'bg-white', 'shadow-sm'));
            document.getElementById(t).classList.add('active');
            document.getElementById('btn-' + t).classList.add('text-slate-900', 'bg-white', 'shadow-sm');
        }
        window.onload = fetchData;
    </script>
</head>
<body class="pb-12 px-4">

    <header class="max-w-md mx-auto pt-8 pb-6">
        <div class="flex justify-between items-end mb-4">
            <h1 class="text-2xl font-black tracking-tight text-slate-800">
                ğŸ· æ¿Ÿè±¬ & æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´» <span class="pixel-star">â˜…</span>
            </h1>
        </div>
        <nav class="flex bg-slate-200/50 p-1 rounded-2xl gap-1">
            <button onclick="openTab('money')" id="btn-money" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl text-slate-900 bg-white shadow-sm">é‡‘éŒ¢</button>
            <button onclick="openTab('mission')" id="btn-mission" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl text-slate-500">ä»»å‹™</button>
            <button onclick="openTab('body')" id="btn-body" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl text-slate-500">é«”é­„</button>
        </nav>
    </header>

    <main class="max-w-md mx-auto space-y-6">
        <section id="money" class="tab-content active space-y-6">
            
            <div class="glass-card p-8 bg-slate-900 text-white border-0 shadow-2xl">
                <div class="flex items-center gap-2 mb-3">
                    <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                    <h2 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">ç›®å‰å…±åŒéŒ¢åŒ…æ°´ä½</h2>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-2xl font-black text-slate-500">$</span>
                    <span id="wallet-balance" class="text-6xl font-black tracking-tighter text-white">...</span>
                </div>
                <div class="mt-8 space-y-3 border-t border-slate-800 pt-5">
                    <div class="flex justify-between items-center font-bold">
                        <span class="text-[11px] text-slate-500">å¾…æ’¥æ¬¾çµ¦ æ¿Ÿè±¬</span>
                        <span id="pig-owed" class="text-orange-400 text-lg">...</span>
                    </div>
                    <div class="flex justify-between items-center font-bold">
                        <span class="text-[11px] text-slate-500">å¾…æ’¥æ¬¾çµ¦ æ¿Ÿæ·¨</span>
                        <span id="clean-owed" class="text-sky-400 text-lg">...</span>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-xs font-black text-slate-400 mb-6 tracking-widest uppercase">ğŸ“Š æ”¯å‡ºæ¯”ä¾‹åˆ†æ (å«é‡‘é¡)</h3>
                <div class="h-72"><canvas id="expenseChart"></canvas></div>
            </div>

            <div class="glass-card p-8">
                <h3 class="text-sm font-black text-slate-700 mb-4 tracking-widest uppercase">ğŸ“œ æœ€è¿‘ 5 ç­†å†’éšªç´€éŒ„</h3>
                <div id="recent-list" class="space-y-1">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="glass-card p-8">
                <h3 class="text-sm font-black text-slate-700 mb-6">âœï¸ ç´€éŒ„æ–°é–‹éŠ·</h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <div class="space-y-6">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" name="entry.2029544290" class="bg-slate-100 border-0 p-3 rounded-xl font-bold text-sm outline-none" required>
                            <select name="entry.1539739800" class="bg-slate-100 border-0 p-3 rounded-xl font-bold text-sm outline-none">
                                <option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option><option value="æ—¥ç”¨">ğŸ§º æ—¥ç”¨</option>
                                <option value="è¨­å‚™">ğŸ’» è¨­å‚™</option><option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                                <option value="ç¤¾äº¤">ğŸ¥‚ ç¤¾äº¤</option><option value="æ”¶å…¥">ğŸ§§ æ”¶å…¥</option>
                            </select>
                        </div>
                        <input type="number" name="entry.1782400014" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-slate-100 border-0 p-4 rounded-xl font-black text-2xl outline-none" required>
                        <div>
                            <label class="text-[10px] font-black text-slate-400 mb-2 block tracking-widest uppercase">Payer / ä»˜æ¬¾äºº</label>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" id="p1" class="payer-option" required>
                                <label for="p1" class="payer-label">æ¿Ÿè±¬å¢Š</label>
                                <input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨" id="p2" class="payer-option">
                                <label for="p2" class="payer-label">æ¿Ÿæ·¨å¢Š</label>
                                <input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…" id="p3" class="payer-option">
                                <label for="p3" class="payer-label">å…¬éŒ¢åŒ…</label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-slate-700 active:scale-95 transition-all text-xs tracking-[0.2em]">
                            åoçˆ» å•Ÿå‹•å‚³é€ çˆ»oå
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <section id="mission" class="tab-content py-20 text-center font-bold text-slate-300">ğŸŒ«ï¸ ä»»å‹™ç³»çµ±è¼‰å…¥ä¸­...</section>
        <section id="body" class="tab-content py-20 text-center font-bold text-slate-300">âš”ï¸ é«”é­„ç³»çµ±è¼‰å…¥ä¸­...</section>
    </main>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>
</body>
</html>
