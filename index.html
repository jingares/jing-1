<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { border-bottom: 4px solid #6366f1; color: #6366f1; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-md mx-auto px-4 py-4 text-center">
            <h1 class="text-xl font-bold text-gray-800">æ¿Ÿè±¬ & æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</h1>
            <nav class="flex justify-around mt-4">
                <button onclick="openTab('mission')" id="btn-mission" class="tab-btn pb-2 px-2 font-bold text-gray-500">ä»»å‹™</button>
                <button onclick="openTab('money')" id="btn-money" class="tab-btn active pb-2 px-2 font-bold text-gray-500">é‡‘éŒ¢</button>
                <button onclick="openTab('body')" id="btn-body" class="tab-btn pb-2 px-2 font-bold text-gray-500">é«”é­„</button>
            </nav>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 pb-20">
        <section id="mission" class="tab-content">
            <h2 class="text-lg font-bold">ä»»å‹™æ¸…å–®</h2>
            <p class="text-purple-600 text-sm">åä¹‚ç‚ºäº†æ˜Ÿæ˜Ÿå¥®èµ·å§åä¹‚</p>
            <p class="mt-4 text-gray-400">ä»»å‹™åŠŸèƒ½é–‹ç™¼ä¸­...</p>
        </section>

        <section id="money" class="tab-content active">
            <div class="mb-4">
                <h2 class="text-lg font-bold text-gray-800">é‡‘éŒ¢ç®¡ç†</h2>
                <p class="text-green-600 text-xs italic">åoçˆ»éŒ¢å‘½å®šoå</p>
            </div>

            <div class="grid grid-cols-1 gap-3 mb-6">
                <div class="bg-indigo-600 text-white p-5 rounded-2xl shadow-lg text-center">
                    <p class="text-xs opacity-80">æœ¬æœˆå…±åŒéŒ¢åŒ…é¤˜é¡ (é ç®—15000)</p>
                    <p id="wallet-balance" class="text-3xl font-bold mt-1">è¼‰å…¥ä¸­...</p>
                </div>
                <div class="flex gap-3">
                    <div class="bg-white flex-1 p-4 rounded-xl shadow-sm border-l-4 border-red-400">
                        <p class="text-[10px] text-gray-500 uppercase">æ‡‰æ’¥çµ¦æ¿Ÿè±¬</p>
                        <p id="pig-reimbursement" class="text-lg font-bold text-gray-800">$0</p>
                    </div>
                    <div class="bg-white flex-1 p-4 rounded-xl shadow-sm border-l-4 border-blue-400">
                        <p class="text-[10px] text-gray-500 uppercase">æ‡‰æ’¥çµ¦æ¿Ÿæ·¨</p>
                        <p id="clean-reimbursement" class="text-lg font-bold text-gray-800">$0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                <h3 class="font-bold mb-4 text-gray-700">ğŸ“ æ–°å¢èŠ±è²»</h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="handleFormSubmit();">
                    
                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">èŠ±è²»æ—¥æœŸ</label>
                        <input type="date" name="entry.2029544290" class="w-full border-gray-200 border p-2 rounded-lg" required>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">é‡‘é¡</label>
                        <input type="number" name="entry.1782400014" placeholder="è¼¸å…¥é‡‘é¡" class="w-full border-gray-200 border p-2 rounded-lg" required>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs text-gray-400 mb-1">é¡åˆ¥</label>
                        <select name="entry.1539739800" class="w-full border-gray-200 border p-2 rounded-lg">
                            <option value="æ—¥ç”¨">æ—¥ç”¨</option>
                            <option value="è¨­å‚™">è¨­å‚™</option>
                            <option value="é£²é£Ÿ">é£²é£Ÿ</option>
                            <option value="æ—…éŠ">æ—…éŠ</option>
                            <option value="ç¤¾äº¤">ç¤¾äº¤</option>
                        </select>
                    </div>

                    <div class="mb-5">
                        <label class="block text-xs text-gray-400 mb-2">ä»˜æ¬¾äºº</label>
                        <div class="flex justify-between bg-gray-50 p-2 rounded-lg">
                            <label class="flex items-center gap-1 text-sm"><input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" required> æ¿Ÿè±¬</label>
                            <label class="flex items-center gap-1 text-sm"><input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨"> æ¿Ÿæ·¨</label>
                            <label class="flex items-center gap-1 text-sm"><input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…"> å…±åŒ</label>
                        </div>
                    </div>

                    <button id="submit-btn" type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md transition">
                        åoçˆ»è¨˜éŒ„ä¸€ç­†oå
                    </button>
                </form>
            </div>
        </section>

        <section id="body" class="tab-content">
            <h2 class="text-lg font-bold">é«”æ ¼ç›£æ¸¬</h2>
            <p class="text-red-600 text-sm">æ–¬åå‡±è’‚è²“åä½›</p>
            <p class="mt-4 text-gray-400">é«”é­„åŠŸèƒ½é–‹ç™¼ä¸­...</p>
        </section>
    </main>
   <script>
    var submitted = false;
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';

    // æå‰å®šç¾©å¥½åŠŸèƒ½
    window.handleIframeLoad = function() {
        if (submitted) {
            alert('âœ¨ ç´€éŒ„æˆåŠŸï¼è³‡æ–™å·²é£›å‘é›²ç«¯ âœ¨');
            window.location.reload();
        }
    };

    function handleFormSubmit() {
        submitted = true;
        const btn = document.getElementById('submit-btn');
        btn.innerText = "å‚³é€ä¸­...";
        btn.disabled = true;
    }
async function fetchData() {
        try {
            console.log("é–‹å§‹æŠ“å–è³‡æ–™...");
            const response = await fetch(csvUrl + '&t=' + new Date().getTime());
            const data = await response.text();
            
            // æª¢æŸ¥æœ‰æ²’æœ‰æŠ“åˆ°æ±è¥¿
            if (!data) {
                console.error("æŠ“åˆ°çš„è³‡æ–™æ˜¯ç©ºçš„");
                return;
            }

            const rows = data.split('\n').slice(1);
            let totalSpent = 0;
            let pigPaid = 0;
            let cleanPaid = 0;

            rows.forEach((row, index) => {
                // æ”¹ç”¨æœ€ç°¡å–®çš„é€—è™Ÿåˆ†å‰²
                const cols = row.split(',').map(c => c.trim().replace(/"/g, ""));
                
                // åªè¦æœ‰é‡‘é¡ (ç¬¬2æ ¼) å°±å¯ä»¥è·‘
                if (cols.length < 2) return;

                const amount = parseFloat(cols[1]) || 0; 
                const payer = cols[3] || "";             
                const isSettled = cols[4] ? cols[4] : ""; // å…ˆæš«æ™‚çœ‹ç¬¬5æˆ–ç¬¬6æ ¼

                totalSpent += amount;

                if (isSettled !== "æ˜¯") {
                    if (payer === "æ¿Ÿè±¬") pigPaid += amount;
                    if (payer === "æ¿Ÿæ·¨") cleanPaid += amount;
                }
            });

            console.log("è¨ˆç®—å®Œæˆ:", { totalSpent, pigPaid, cleanPaid });

            // å¼·åˆ¶æ›´æ–°ç•«é¢
            document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent);
            document.getElementById('pig-reimbursement').innerText = '$' + pigPaid;
            document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid;

        } catch (e) {
            console.error("fetchData ç™¼ç”ŸéŒ¯èª¤:", e);
            document.getElementById('wallet-balance').innerText = "é€£ç·šå¤±æ•—";
        }
    }
    fetchData();

    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.getElementById('btn-' + tabName).classList.add('active');
    }
</script>
<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>

</body>
</html>
