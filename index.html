<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åoçˆ»æ¿Ÿè±¬&æ·¨æ·¨ä¹‹éŒ¢å‘½å®šoå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --pixel-border: 3px solid #000;
            --pixel-shadow: 4px 4px 0px #000;
        }
        body { 
            background-color: #ffdee9; 
            background-image: linear-gradient(0deg, #ffdee9 0%, #b5fffc 100%);
            font-family: 'ZCOOL KuaiLe', cursive; 
        }
        .pixel-card {
            background: white;
            border: var(--pixel-border);
            box-shadow: var(--pixel-shadow);
            image-rendering: pixelated;
        }
        .pixel-btn {
            border: var(--pixel-border);
            box-shadow: 2px 2px 0px #000;
            transition: all 0.1s;
        }
        .pixel-btn:active {
            box-shadow: 0px 0px 0px #000;
            transform: translate(2px, 2px);
        }
        .tag-pig { background-color: #ff4e50; color: white; border: 1px solid #000; } /* æ¿Ÿè±¬ï¼šæ©˜ç´… */
        .tag-clean { background-color: #00d2ff; color: white; border: 1px solid #000; } /* æ¿Ÿæ·¨ï¼šæ°´è— */
        .tag-both { background-color: #9d50bb; color: white; border: 1px solid #000; } /* å…±åŒï¼šç´«è‰² */
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>

    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('ğŸ’¥ åoçˆ» æ•¸æ“šå·²é£›å‘ç•°ä¸–ç•Œ çˆ»oå ğŸ’¥');
                location.reload();
            }
        };

        async function fetchData() {
            try {
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                
                let totalSpent = 0;
                let pigPaid = 0;
                let cleanPaid = 0;
                let categoryData = {};
                let recentHtml = "";

                const reversedRows = [...rows].reverse();

                reversedRows.forEach((row, index) => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    if (cols.length < 2) return;

                    const amount = parseFloat(cols[1]) || 0; 
                    const cat = cols[2] || "æœªåˆ†é¡";
                    const payer = cols[3] || "";             
                    const expenseDate = cols[4] || "ç„¡æ—¥æœŸ";
                    const isSettled = cols[5] || ""; 

                    totalSpent += amount;
                    if (isSettled !== "æ˜¯") {
                        if (payer === "æ¿Ÿè±¬") pigPaid += amount;
                        if (payer === "æ¿Ÿæ·¨") cleanPaid += amount;
                    }

                    categoryData[cat] = (categoryData[cat] || 0) + amount;

                    if (index < 5) {
                        let tagClass = "tag-both";
                        if(payer === "æ¿Ÿè±¬") tagClass = "tag-pig";
                        if(payer === "æ¿Ÿæ·¨") tagClass = "tag-clean";

                        recentHtml += `
                            <div class="flex justify-between items-center border-b-2 border-dashed border-gray-300 py-3">
                                <div>
                                    <span class="block text-lg font-bold">â–¶ ${cat}</span>
                                    <span class="text-xs text-gray-500">${expenseDate}</span>
                                </div>
                                <div class="text-right">
                                    <span class="block text-xl font-bold">$${amount}</span>
                                    <span class="text-[10px] px-2 py-0.5 rounded-sm ${tagClass}">${payer}</span>
                                </div>
                            </div>`;
                    }
                });

                document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent);
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid;
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid;
                document.getElementById('chart-total').innerText = 'ç¸½è¨ˆ:$' + totalSpent;
                document.getElementById('recent-list').innerHTML = recentHtml || "ç„¡ç´€éŒ„";

                renderChart(categoryData, totalSpent);
            } catch (e) { console.error(e); }
        }

        function renderChart(catData, total) {
            const ctx = document.getElementById('expenseChart');
            if (expenseChart) expenseChart.destroy();
            
            const labels = Object.keys(catData);
            const values = Object.values(catData);
            const percentages = values.map(v => ((v / total) * 100).toFixed(1) + '%');

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map((l, i) => `${l} (${percentages[i]})`),
                    datasets: [{
                        data: values,
                        backgroundColor: ['#ff4e50', '#00d2ff', '#fbbf24', '#34d399', '#9d50bb', '#f472b6'],
                        borderWidth: 3,
                        borderColor: '#000'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#000', font: { size: 14 } } }
                    }
                }
            });
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'bg-yellow-300'));
            document.getElementById(tabName).classList.add('active');
            document.getElementById('btn-' + tabName).classList.add('active', 'bg-yellow-300');
        }

        window.onload = fetchData;
    </script>
</head>
<body class="p-4">

    <header class="max-w-md mx-auto mb-6">
        <div class="pixel-card p-4 text-center bg-white">
            <h1 class="text-2xl font-bold tracking-tighter">âš”ï¸ æ¿Ÿè±¬ âš”ï¸ æ·¨æ·¨ âš”ï¸</h1>
            <nav class="flex gap-2 mt-4">
                <button onclick="openTab('money')" id="btn-money" class="tab-btn pixel-btn flex-1 py-2 bg-yellow-300 font-bold">éŒ¢å‘½å®š</button>
                <button onclick="openTab('mission')" id="btn-mission" class="tab-btn pixel-btn flex-1 py-2 bg-white font-bold">è§£ä»»å‹™</button>
                <button onclick="openTab('body')" id="btn-body" class="tab-btn pixel-btn flex-1 py-2 bg-white font-bold">ç·´é«”é­„</button>
            </nav>
        </div>
    </header>

    <main class="max-w-md mx-auto space-y-6">
        <section id="money" class="tab-content active space-y-6">
            
            <div class="pixel-card p-6 bg-gradient-to-r from-purple-400 to-pink-400 text-white text-center">
                <p class="text-sm font-bold mb-1">å å…±åŒéŒ¢åŒ…å‰©é¤˜ å</p>
                <p id="wallet-balance" class="text-5xl font-black drop-shadow-[2px_2px_0px_rgba(0,0,0,1)]">...</p>
            </div>

            <div class="pixel-card p-6 bg-white relative">
                <h3 class="font-bold mb-4 text-xl italic underline">â–¶ æ”¯å‡ºæ¯”ä¾‹åˆ†æ</h3>
                <div class="h-64 relative">
                    <canvas id="expenseChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span id="chart-total" class="text-sm font-bold bg-black text-white px-2 py-1">ç¸½è¨ˆ:?</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="pixel-card p-4 tag-pig">
                    <p class="text-[10px] font-bold uppercase">æ‡‰æ’¥çµ¦ æ¿Ÿè±¬</p>
                    <p id="pig-reimbursement" class="text-2xl font-bold">$0</p>
                </div>
                <div class="pixel-card p-4 tag-clean">
                    <p class="text-[10px] font-bold uppercase">æ‡‰æ’¥çµ¦ æ¿Ÿæ·¨</p>
                    <p id="clean-reimbursement" class="text-2xl font-bold">$0</p>
                </div>
            </div>

            <div class="pixel-card p-6 bg-white">
                <h3 class="font-bold mb-4 text-xl italic underline">â–¶ æœ€è¿‘ 5 ç­†æˆ°æœ</h3>
                <div id="recent-list" class="space-y-1">è¼‰å…¥ä¸­...</div>
            </div>

            <div class="pixel-card p-6 bg-green-100">
                <h3 class="font-bold mb-4 text-xl">âœš è¨˜å…¥æ–°èŠ±è²»</h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <div class="space-y-4">
                        <input type="date" name="entry.2029544290" class="w-full border-2 border-black p-3 text-sm focus:outline-none" required>
                        <input type="number" name="entry.1782400014" placeholder="è¼¸å…¥é‡‘é¡" class="w-full border-2 border-black p-3 text-sm focus:outline-none" required>
                        <select name="entry.1539739800" class="w-full border-2 border-black p-3 text-sm focus:outline-none">
                            <option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option>
                            <option value="æ—¥ç”¨">ğŸ§º æ—¥ç”¨</option>
                            <option value="è¨­å‚™">ğŸ’» è¨­å‚™</option>
                            <option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                            <option value="ç¤¾äº¤">ğŸ¥‚ ç¤¾äº¤</option>
                        </select>
                        <div class="flex justify-around bg-white border-2 border-black p-3">
                            <label class="flex items-center text-xs font-bold cursor-pointer text-red-500">
                                <input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" class="mr-1" required> æ¿Ÿè±¬
                            </label>
                            <label class="flex items-center text-xs font-bold cursor-pointer text-blue-500">
