<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„è§€æ¸¬ç«™</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: #ffffff; border: 2px solid #e2e8f0; box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.05); border-radius: 1.5rem; }
        .payer-option { display: none; }
        .payer-label { display: flex; align-items: center; justify-content: center; padding: 12px 8px; border-radius: 12px; font-weight: 700; font-size: 13px; background: #f1f5f9; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .payer-option:checked + .payer-label { background: #1e293b; color: white; border-color: #1e293b; transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tag-pig { color: #f97316; background: #fff7ed; border-radius: 6px; padding: 2px 8px; }
        .tag-clean { color: #0ea5e9; background: #f0f9ff; border-radius: 6px; padding: 2px 8px; }
    </style>

    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?gid=1296893534&single=true&output=csv';
        const bodyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?gid=857338261&single=true&output=csv';

        window.handleIframeLoad = function() {
            if (submitted) {
                const currentTab = document.querySelector('.tab-content.active').id;
                localStorage.setItem('activeTab', currentTab);
                alert('âœ¨ ç´€éŒ„å­˜æª”æˆåŠŸï¼ âœ¨');
                location.reload();
            }
        };

        window.onload = function() {
            // è‡ªå‹•è¨­å®šä»Šå¤©çš„æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('money-date').value = today;
            document.getElementById('body-date').value = today;

            fetchData();
            fetchBodyData();
            const lastTab = localStorage.getItem('activeTab') || 'money';
            openTab(lastTab);
        };

        // é‡‘éŒ¢è³‡æ–™è™•ç†èˆ‡åœ“é¤…åœ– (å·²éæ¿¾æ”¶å…¥)
        async function fetchData() {
            try {
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                let totalSpent = 0, pigPaid = 0, cleanPaid = 0, categoryData = {}, recentHtml = "";

                rows.forEach(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const amt = parseFloat(c[1]) || 0;
                    const cat = c[2], payer = c[3];
                    const isInc = (c[5] && c[5].includes("æ˜¯")) || cat === "æ”¶å…¥";

                    if (!isInc) {
                        totalSpent += amt;
                        categoryData[cat] = (categoryData[cat] || 0) + amt;
                        if (payer === "æ¿Ÿè±¬") pigPaid += amt;
                        if (payer === "æ¿Ÿæ·¨") cleanPaid += amt;
                    }
                });

                [...rows].reverse().slice(0, 5).forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    const isPig = cols[3] === "æ¿Ÿè±¬";
                    const isInc = (cols[5] && cols[5].includes("æ˜¯")) || cols[2] === "æ”¶å…¥";
                    recentHtml += `<div class="flex justify-between items-center py-4 border-b border-slate-50 last:border-0">
                        <div><div class="font-bold text-slate-700 text-sm">${cols[2]} ${isInc ? '<span class="text-emerald-500">[æ”¶å…¥]</span>':''}</div>
                        <div class="text-[11px] text-slate-400">${cols[4]}</div></div>
                        <div class="text-right"><div class="font-black text-slate-800">$${parseFloat(cols[1]).toLocaleString()}</div>
                        <span class="text-[10px] font-bold ${isPig?'tag-pig':'tag-clean'}">${cols[3]}</span></div></div>`;
                });

                document.getElementById('wallet-balance').innerText = (15000 - totalSpent).toLocaleString();
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid.toLocaleString();
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid.toLocaleString();
                document.getElementById('recent-list').innerHTML = recentHtml || "å°šæœªæœ‰ç´€éŒ„";
                renderMoneyChart(categoryData);
            } catch (e) { console.error(e); }
        }

        // é«”é­„è³‡æ–™è™•ç†èˆ‡æ’åºåœ–è¡¨
        async function fetchBodyData() {
            try {
                const response = await fetch(`${bodyCsvUrl}&t=${Date.now()}`);
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                let bodyMap = {}, recentBodyHtml = "";

                rows.forEach(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const date = c[1], user = c[2], weight = parseFloat(c[3]);
                    if (!date || isNaN(weight)) return;
                    if (!bodyMap[date]) bodyMap[date] = { "æ¿Ÿè±¬": [], "æ¿Ÿæ·¨": [] };
                    bodyMap[date][user].push(weight);
                });

                [...rows].reverse().slice(0, 5).forEach(c => {
                    const col = c.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const isPig = col[2] === "æ¿Ÿè±¬";
                    recentBodyHtml += `<div class="flex justify-between items-center py-4 border-b border-slate-50 last:border-0">
                        <div><div class="font-bold text-slate-700 text-sm">${col[1]} (${col[5]})</div>
                        <span class="text-[10px] font-bold ${isPig?'tag-pig':'tag-clean'}">${col[2]}</span></div>
                        <div class="text-right"><div class="font-black text-slate-800">${col[3]} kg</div>
                        <div class="text-[10px] text-slate-400">é«”è„‚ ${col[4]}%</div></div></div>`;
                });
                document.getElementById('body-recent-list').innerHTML = recentBodyHtml;

                const sortedDates = Object.keys(bodyMap).sort();
                renderBodyChart(sortedDates, bodyMap);
            } catch (e) { console.error(e); }
        }

        // é‡‘éŒ¢è¡¨å–®é€å‡ºå‰çš„è‡ªå‹•è½‰æ› (å°‡æ—¥æœŸé¸æ“‡å™¨æ‹†å›è¡¨å–®éœ€è¦çš„å¹´ã€æœˆã€æ—¥)
        function prepareMoneySubmit() {
            const dateVal = document.getElementById('money-date').value; // YYYY-MM-DD
            if (!dateVal) return;
            const parts = dateVal.split('-');
            document.getElementById('m-year').value = parts[0];
            document.getElementById('m-month').value = parts[1];
            document.getElementById('m-day').value = parts[2];
            submitted = true;
        }

        // åœ–è¡¨æ¸²æŸ“
        function renderMoneyChart(categoryData) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{ data: Object.values(categoryData), backgroundColor: ['#f87171', '#fb923c', '#fbbf24', '#4ade80', '#60a5fa', '#818cf8'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function renderBodyChart(labels, bodyMap) {
            const ctx = document.getElementById('bodyChart').getContext('2d');
            const getPoints = (u) => labels.map(d => bodyMap[d][u].length ? Math.max(...bodyMap[d][u]) : null);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æ¿Ÿè±¬', data: getPoints('æ¿Ÿè±¬'), borderColor: '#f97316', tension: 0.3, spanGaps: true },
                        { label: 'æ¿Ÿæ·¨', data: getPoints('æ¿Ÿæ·¨'), borderColor: '#0ea5e9', tension: 0.3, spanGaps: true }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function openTab(t) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('text-slate-900', 'bg-white', 'shadow-sm'));
            document.getElementById(t).classList.add('active');
            document.getElementById('btn-' + t).classList.add('text-slate-900', 'bg-white', 'shadow-sm');
        }
    </script>
</head>
<body class="pb-12 px-4">
    <header class="max-w-md mx-auto pt-8 pb-6 text-center">
        <h1 class="text-2xl font-black tracking-tight text-slate-800">æ¿Ÿè±¬ & æ¿Ÿæ·¨çš„è§€æ¸¬ç«™ ğŸ·ğŸ£</h1>
        <nav class="flex bg-slate-200/50 p-1 rounded-2xl gap-1 mt-4">
            <button onclick="openTab('money')" id="btn-money" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl transition-all">é‡‘éŒ¢</button>
            <button onclick="openTab('mission')" id="btn-mission" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl transition-all">ä»»å‹™</button>
            <button onclick="openTab('body')" id="btn-body" class="tab-btn flex-1 py-2 font-bold text-sm rounded-xl transition-all">é«”é­„</button>
        </nav>
    </header>

    <main class="max-w-md mx-auto space-y-6">
        <section id="money" class="tab-content active space-y-6">
            <div class="glass-card p-8 text-center bg-white">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1">é ç®—å‰©é¤˜ (ä¸å«æ”¶å…¥)</h2>
                <div class="text-5xl font-black text-slate-800">$ <span id="wallet-balance">...</span></div>
            </div>
            <div class="glass-card p-6 h-72"><canvas id="expenseChart"></canvas></div>
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-4 border-t-4 border-orange-400"><p class="text-[10px] font-bold text-slate-400">æ‡‰æ’¥çµ¦ æ¿Ÿè±¬</p><p id="pig-reimbursement" class="text-lg font-black">$0</p></div>
                <div class="glass-card p-4 border-t-4 border-sky-400"><p class="text-[10px] font-bold text-slate-400">æ‡‰æ’¥çµ¦ æ¿Ÿæ·¨</p><p id="clean-reimbursement" class="text-lg font-black">$0</p></div>
            </div>
            <div class="glass-card p-6"><h3 class="text-sm font-black mb-4">ğŸ“œ æœ€è¿‘ 5 ç­†ç´€éŒ„</h3><div id="recent-list" class="space-y-1"></div></div>
            <div class="glass-card p-8">
                <form action="https://docs.google.com/forms/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" method="POST" target="hidden_iframe" onsubmit="prepareMoneySubmit()">
                    <input type="hidden" name="entry.2029544290_year" id="m-year">
                    <input type="hidden" name="entry.2029544290_month" id="m-month">
                    <input type="hidden" name="entry.2029544290_day" id="m-day">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" id="money-date" class="bg-slate-100 p-3 rounded-xl font-bold text-sm outline-none">
                            <select name="entry.1539739800" class="bg-slate-100 p-3 rounded-xl font-bold text-sm"><option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option><option value="æ—¥ç”¨">ğŸ§º æ—¥ç”¨</option><option value="è¨­å‚™">ğŸ’» è¨­å‚™</option><option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option><option value="æ”¶å…¥">ğŸ’° æ”¶å…¥é …ç›®</option></select>
                        </div>
                        <input type="number" name="entry.1782400014" placeholder="è¼¸å…¥é‡‘é¡" class="w-full bg-slate-100 p-4 rounded-xl font-black text-xl outline-none" required>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" id="mp1" class="payer-option" required><label for="mp1" class="payer-label">æ¿Ÿè±¬</label>
                            <input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨" id="mp2" class="payer-option"><label for="mp2" class="payer-label">æ¿Ÿæ·¨</label>
                            <input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…" id="mp3" class="payer-option"><label for="mp3" class="payer-label">å…±åŒ</label>
                        </div>
                        <button type="submit" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black">å­˜å…¥ç´€éŒ„</button>
                    </div>
                </form>
            </div>
        </section>

        <section id="mission" class="tab-content py-20 text-center font-bold text-slate-300">æ–½å·¥ä¸­...</section>

        <section id="body" class="tab-content space-y-6">
            <div class="glass-card p-6 h-72"><canvas id="bodyChart"></canvas></div>
            <div class="glass-card p-6"><h3 class="text-sm font-black mb-4">ğŸ“œ æœ€è¿‘ 5 ç­†é€²åŒ–ç´€éŒ„</h3><div id="body-recent-list" class="space-y-1"></div></div>
            <div class="glass-card p-8">
                <form action="https://docs.google.com/forms/d/e/1FAIpQLSf6he1iDoiMPdEYIM6lRDe2iAa86lYigpL6oejqCAKqC7nPSw/formResponse" method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="date" id="body-date" name="entry.1084185584" class="bg-slate-100 p-3 rounded-xl font-bold text-sm outline-none" required>
                            <select name="entry.1827803948" class="bg-slate-100 p-3 rounded-xl font-bold text-sm"><option value="æ—©">ğŸŒ… æ™¨é–“</option><option value="æ™š">ğŸŒƒ ç¡å‰</option></select>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <select name="entry.1906297204" class="bg-slate-100 p-3 rounded-xl font-bold text-sm"><option value="æ¿Ÿè±¬">ğŸ· æ¿Ÿè±¬</option><option value="æ¿Ÿæ·¨">ğŸ£ æ¿Ÿæ·¨</option></select>
                            <input type="number" step="0.1" name="entry.2076780180" placeholder="é«”é‡ (kg)" class="bg-slate-100 p-3 rounded-xl font-bold outline-none" required>
                        </div>
                        <input type="number" step="0.1" name="entry.1197675866" placeholder="é«”è„‚ (%)" class="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none">
                        <button type="submit" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black">æ›´æ–°é«”é­„</button>
                    </div>
                </form>
            </div>
        </section>
    </main>
    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>
</body>
</html>
