<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿Ÿè±¬&æ¿Ÿæ·¨çš„å…©äººç”Ÿæ´»</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="icon" href="https://fav.farm/ğŸ·">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f0f0; }
        .pixel-border { border: 3px solid #000; box-shadow: 4px 4px 0px #000; }
        .pixel-btn:active { box-shadow: 0px 0px 0px #000; transform: translate(4px, 4px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* é¸é …æŒ‰éˆ•ç¾åŒ– */
        .payer-option { display: none; }
        .payer-label { border: 2px solid #000; padding: 10px 5px; text-align: center; font-size: 12px; font-weight: 900; cursor: pointer; background: #fff; transition: all 0.1s; }
        .payer-option:checked + .payer-label { background: #000; color: #fff; }

        /* æ¨™ç±¤é¡è‰² */
        .tag-pig { background-color: #ffedd5; color: #ea580c; border: 1px solid #fdba74; }
        .tag-clean { background-color: #e0f2fe; color: #0284c7; border: 1px solid #7dd3fc; }
        .tag-common { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
    </style>

    <script>
        var submitted = false;
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTp-3jXGhNPGZhYixtC9vJ1GFCyBYRqU856YVEkUXJaTpsnNg48N3AMPsvbuAicL9XEFS00ibi0Ioh9/pub?output=csv';
        let expenseChart;

        window.handleIframeLoad = function() {
            if (submitted) {
                alert('âœ¨ ç´€éŒ„æˆåŠŸï¼åoçˆ»éŒ¢éŒ¢é£›èµ°äº†çˆ»oå âœ¨');
                location.reload();
            }
        };

        async function fetchData() {
            try {
                const response = await fetch(`${csvUrl}&t=${Date.now()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.text();
                const rows = data.split('\n').filter(r => r.trim() !== "").slice(1);
                
                let totalSpent = 0;
                let pigPaid = 0;
                let cleanPaid = 0;
                let categoryData = {};
                let recentHtml = "";

                // å…ˆç®—ç¸½é¡
                rows.forEach(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ""));
                    const amt = parseFloat(c[1]) || 0;
                    totalSpent += amt;
                    const payer = c[3] || "";
                    const isSettled = c[5] || "";
                    if (isSettled !== "æ˜¯") {
                        if (payer === "æ¿Ÿè±¬") pigPaid += amt;
                        if (payer === "æ¿Ÿæ·¨") cleanPaid += amt;
                    }
                    const cat = c[2] || "æœªåˆ†é¡";
                    categoryData[cat] = (categoryData[cat] || 0) + amt;
                });

                // ç”¢å‡ºæ˜ç´° (å‰ 5 ç­†)
                [...rows].reverse().slice(0, 5).forEach(row => {
                    const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ""));
                    const amount = parseFloat(cols[1]) || 0;
                    const payer = cols[3] || "";
                    let tagClass = payer === "æ¿Ÿè±¬" ? "tag-pig" : (payer === "æ¿Ÿæ·¨" ? "tag-clean" : "tag-common");
                    recentHtml += `
                        <div class="flex justify-between items-center py-3 border-b border-black/5 last:border-0">
                            <div>
                                <div class="font-bold text-gray-900">${cols[2]}</div>
                                <div class="text-[11px] text-gray-400 font-medium">${cols[4]}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-lg">$${amount.toLocaleString()}</div>
                                <span class="text-[10px] px-2 py-0.5 rounded ${tagClass}">${payer}</span>
                            </div>
                        </div>`;
                });

                document.getElementById('wallet-balance').innerText = '$' + (15000 - totalSpent).toLocaleString();
                document.getElementById('pig-reimbursement').innerText = '$' + pigPaid.toLocaleString();
                document.getElementById('clean-reimbursement').innerText = '$' + cleanPaid.toLocaleString();
                document.getElementById('recent-list').innerHTML = recentHtml || "å°šæœªæœ‰ä»»ä½•å‚³èªªç´€éŒ„";

                renderChart(categoryData, totalSpent);
            } catch (e) { console.error("æŠ“å–å¤±æ•—:", e); }
        }

        function renderChart(catData, grandTotal) {
            const ctx = document.getElementById('expenseChart');
            if (!ctx) return;
            if (expenseChart) expenseChart.destroy();

            const labels = Object.keys(catData).map(key => {
                const pct = ((catData[key] / grandTotal) * 100).toFixed(1);
                return `${key} ${pct}%`;
            });

            expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(catData),
                        backgroundColor: ['#6366f1', '#f87171', '#fbbf24', '#34d399', '#a78bfa', '#f472b6'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold', size: 11 } } } }
                },
                plugins: [{
                    id: 'centerText',
                    beforeDraw: (chart) => {
                        const { width, height, ctx } = chart;
                        ctx.restore();
                        ctx.font = "900 12px Noto Sans TC";
                        ctx.textAlign = "center";
                        ctx.fillStyle = "#9ca3af";
                        ctx.fillText("ç¸½æ”¯å‡º", width / 2, height / 2 - 12);
                        ctx.font = "900 18px Noto Sans TC";
                        ctx.fillStyle = "#111827";
                        ctx.fillText(`$${grandTotal.toLocaleString()}`, width / 2, height / 2 + 10);
                        ctx.save();
                    }
                }]
            });
        }

        function openTab(t) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('bg-black', 'text-white'));
            document.getElementById(t).classList.add('active');
            document.getElementById('btn-' + t).classList.add('bg-black', 'text-white');
        }

        window.onload = fetchData;
    </script>
</head>
<body class="pb-10">

    <header class="bg-white border-b-4 border-black sticky top-0 z-20">
        <div class="max-w-md mx-auto px-4 py-6 text-center">
            <h1 class="text-xl font-black tracking-tighter">â–  æ¿Ÿè±¬ Ã— æ¿Ÿæ·¨ï¼šç”Ÿæ´»è§€æ¸¬ç«™ â– </h1>
            <nav class="flex mt-6 gap-2">
                <button onclick="openTab('money')" id="btn-money" class="tab-btn flex-1 py-3 font-black pixel-border bg-black text-white text-xs pixel-btn">é‡‘éŒ¢</button>
                <button onclick="openTab('mission')" id="btn-mission" class="tab-btn flex-1 py-3 font-black pixel-border bg-white text-xs pixel-btn">ä»»å‹™</button>
                <button onclick="openTab('body')" id="btn-body" class="tab-btn flex-1 py-3 font-black pixel-border bg-white text-xs pixel-btn">é«”é­„</button>
            </nav>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4">
        <section id="money" class="tab-content active">
            <div class="bg-white pixel-border p-8 mb-8 relative">
                <div class="absolute top-0 right-0 bg-black text-white px-2 py-1 text-[9px] font-bold">VER 2.0</div>
                <p class="text-[11px] font-black text-gray-400 mb-1">â— å…±åŒéŒ¢åŒ…é¤˜é¡</p>
                <p id="wallet-balance" class="text-5xl font-black tracking-tighter">...</p>
            </div>

            <div class="bg-white pixel-border p-6 mb-8">
                <h3 class="font-black text-xs mb-6 tracking-widest">â–¶ æ”¯å‡ºæ¯”ä¾‹åˆ†æ_</h3>
                <div class="h-72"><canvas id="expenseChart"></canvas></div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white pixel-border p-5 border-t-8 border-t-[#ea580c]">
                    <p class="text-[10px] font-black text-gray-400 mb-1">æ‡‰æ’¥çµ¦ / æ¿Ÿè±¬</p>
                    <p id="pig-reimbursement" class="text-2xl font-black">$0</p>
                </div>
                <div class="bg-white pixel-border p-5 border-t-8 border-t-[#0284c7]">
                    <p class="text-[10px] font-black text-gray-400 mb-1">æ‡‰æ’¥çµ¦ / æ¿Ÿæ·¨</p>
                    <p id="clean-reimbursement" class="text-2xl font-black">$0</p>
                </div>
            </div>

            <div class="bg-white pixel-border p-6 mb-8">
                <h3 class="font-black text-xs mb-4 tracking-widest">â–¶ æœ€è¿‘ 5 ç­†ç´€éŒ„_</h3>
                <div id="recent-list" class="space-y-1">è®€å–ä¸­...</div>
            </div>

            <div class="bg-white pixel-border p-6">
                <h3 class="font-black text-xs mb-6 tracking-widest">â–¶ æ–°å¢é–‹éŠ·ç´€éŒ„_</h3>
                <form action="https://docs.google.com/forms/u/1/d/e/1FAIpQLSd3pRv9-m4Tkd0duGqCn3YkUb_cTYz2oP3GY5Ht5WwPOVG1KA/formResponse" 
                      method="POST" target="hidden_iframe" onsubmit="submitted=true;">
                    <div class="space-y-5">
                        <div>
                            <label class="text-[10px] font-black text-gray-400 mb-1 block">DATE / æ—¥æœŸ</label>
                            <input type="date" name="entry.2029544290" class="w-full border-2 border-black p-3 font-bold text-sm outline-none bg-gray-50" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-gray-400 mb-1 block">COST / é‡‘é¡</label>
                            <input type="number" name="entry.1782400014" placeholder="0" class="w-full border-2 border-black p-3 font-bold text-sm outline-none bg-gray-50" required>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-gray-400 mb-1 block">CAT / é¡åˆ¥</label>
                            <select name="entry.1539739800" class="w-full border-2 border-black p-3 font-bold text-sm bg-white outline-none">
                                <option value="é£²é£Ÿ">ğŸ• é£²é£Ÿ</option><option value="æ—¥ç”¨">ğŸ§º æ—¥ç”¨</option>
                                <option value="è¨­å‚™">ğŸ’» è¨­å‚™</option><option value="æ—…éŠ">âœˆï¸ æ—…éŠ</option>
                                <option value="ç¤¾äº¤">ğŸ¥‚ ç¤¾äº¤</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-gray-400 mb-1 block">PAYER / ä»˜æ¬¾äºº</label>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="radio" name="entry.1122156127" value="æ¿Ÿè±¬" id="p1" class="payer-option" required>
                                <label for="p1" class="payer-label">æ¿Ÿè±¬</label>
                                
                                <input type="radio" name="entry.1122156127" value="æ¿Ÿæ·¨" id="p2" class="payer-option">
                                <label for="p2" class="payer-label">æ¿Ÿæ·¨</label>
                                
                                <input type="radio" name="entry.1122156127" value="å…±åŒéŒ¢åŒ…" id="p3" class="payer-option">
                                <label for="p3" class="payer-label">å…±åŒ</label>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-black text-white py-5 font-black pixel-border pixel-btn text-sm">
                            åoçˆ» ç´€éŒ„å­˜æª” çˆ»oå
                        </button>
                    </div>
                </form>
            </div>
        </section>
        <section id="mission" class="tab-content text-center py-20 font-black text-gray-400 text-xs">COMMING SOON...</section>
        <section id="body" class="tab-content text-center py-20 font-black text-gray-400 text-xs">LOCKED...</section>
    </main>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="handleIframeLoad()"></iframe>
</body>
</html>
